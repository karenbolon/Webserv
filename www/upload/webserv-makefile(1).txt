# WebServ Makefile

# Compiler and flags
CXX = c++
CXXFLAGS = -Wall -Wextra -Werror -std=c++98 -pedantic
LDFLAGS = -lssl -lcrypto

# Directories
SRC_DIR = src
OBJ_DIR = obj
INC_DIR = include

# Source files
SRC_FILES = $(shell find $(SRC_DIR) -name "*.cpp")
OBJ_FILES = $(patsubst $(SRC_DIR)/%.cpp,$(OBJ_DIR)/%.o,$(SRC_FILES))

# Header files
INC_FILES = $(shell find $(INC_DIR) -name "*.hpp")

# Target executable
NAME = webserv

# Colors for pretty output
GREEN = \033[0;32m
YELLOW = \033[0;33m
RESET = \033[0m

# Default target
all: $(NAME)

# Create object directory structure
$(OBJ_DIR)/%.o: $(SRC_DIR)/%.cpp $(INC_FILES)
	@mkdir -p $(dir $@)
	@echo "$(YELLOW)Compiling $<$(RESET)"
	@$(CXX) $(CXXFLAGS) -I$(INC_DIR) -c $< -o $@

# Link object files to create executable
$(NAME): $(OBJ_FILES)
	@echo "$(YELLOW)Linking $(NAME)$(RESET)"
	@$(CXX) $(CXXFLAGS) $(OBJ_FILES) $(LDFLAGS) -o $(NAME)
	@echo "$(GREEN)$(NAME) successfully built!$(RESET)"

# Clean object files
clean:
	@echo "$(YELLOW)Cleaning object files$(RESET)"
	@rm -rf $(OBJ_DIR)

# Clean object files and executable
fclean: clean
	@echo "$(YELLOW)Cleaning executable$(RESET)"
	@rm -f $(NAME)

# Rebuild everything
re: fclean all

# Run the server with default configuration
run: all
	@echo "$(GREEN)Starting $(NAME) with default configuration$(RESET)"
	@./$(NAME) conf/default.conf

# Run tests
test: all
	@echo "$(GREEN)Running tests$(RESET)"
	@./tests/run_tests.sh

# Create directory structure
init:
	@echo "$(YELLOW)Creating project structure$(RESET)"
	@mkdir -p $(SRC_DIR)/config $(SRC_DIR)/http $(SRC_DIR)/server $(SRC_DIR)/utils
	@mkdir -p $(INC_DIR)
	@mkdir -p conf www/errors www/cgi-bin www/uploads
	@mkdir -p tests
	@touch conf/default.conf
	@echo "$(GREEN)Project structure created!$(RESET)"

# Generate documentation
doc:
	@echo "$(YELLOW)Generating documentation$(RESET)"
	@doxygen Doxyfile
	@echo "$(GREEN)Documentation generated!$(RESET)"

# Bonus target
bonus: all
	@echo "$(GREEN)Bonus features included!$(RESET)"

# Non-standard targets that won't create files with these names
.PHONY: all clean fclean re run test init doc bonus